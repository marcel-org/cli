# Marcel Token Implementation Summary

## Overview
This implementation adds CLI access to Marcel via secure token-based authentication. Users can generate a personal CLI token from the frontend settings and use it to authenticate the Marcel CLI tool.

## Changes Made

### 1. Backend Changes

#### `/backend/src/lib/jwt.ts`
**Added:**
- `marcelTokenMiddleware()` - Validates Marcel tokens (Bearer tokens starting with `marcel_`)
- `hybridAuthMiddleware()` - Supports both Marcel tokens and JWT cookies
  - First tries to validate Marcel token from Authorization header
  - Falls back to JWT cookie validation for web app

**Purpose:** Allow CLI to authenticate with static tokens while maintaining web app JWT authentication

#### `/backend/src/routes/quest.ts`
**Changed:**
- Import: `jwtMiddleware` → `hybridAuthMiddleware`
- Middleware: `quest.use('/*', hybridAuthMiddleware)`

**Purpose:** Enable CLI access to quest endpoints

#### `/backend/src/routes/user.ts`
**Already existed:**
- `POST /user/marcel-token/generate` - Generate new token (only if none exists)
- `POST /user/marcel-token/regenerate` - Regenerate token (replaces existing)
- `GET /user/marcel-token` - Retrieve current token

**Token format:** `marcel_` + 64 hex characters (crypto.randomBytes(32))

### 2. Frontend Changes

#### `/frontend/src/routes/(app)/settings/+page.svelte`
**Added section: "Marcel CLI Token"**

Features:
- Generate/regenerate token button
- Display current token with copy functionality
- Usage instructions showing:
  - Environment variable setup: `export MARCEL_TOKEN="..."`
  - Config file option: `~/.marcel.yml`
  - CLI command: `marcel`

UI Elements:
- Purple gradient styling matching Marcel brand
- Copy button with visual feedback ("Copied!")
- Refresh button to regenerate token
- Info panel with step-by-step instructions

### 3. CLI Changes

#### `/cli/config/config.go`
**Changed:**
- Config file path: `~/.marcel-cli.yml` → `~/.marcel.yml`

**Purpose:** Simplified config file name

#### `/cli/models/models.go`
**Fixed:**
- `NewQuest()` - Changed `IsCompleted` → `Done`
- `NewJourney()` - Changed `Title` → `Name`

**Purpose:** Match backend API field names

#### `/cli/main.go`
**Updated:**
- Help text: References `~/.marcel.yml`

#### `/cli/ui/ui.go`
**Updated:**
- Help screen: References `~/.marcel.yml`

#### `/cli/README.md`
**Updated:**
- All references to config file now use `~/.marcel.yml`

### 4. Database Schema

#### `backend/prisma/schema/user.prisma`
**Field already existed:**
```prisma
marcelToken  String?  @unique
```

No migration needed - schema already supported tokens.

## Authentication Flow

### CLI Authentication
```
1. CLI reads MARCEL_TOKEN from env or ~/.marcel.yml
2. Sends request: GET /quest
   Headers: Authorization: Bearer marcel_abc123...
3. Backend hybridAuthMiddleware:
   - Detects Bearer token starting with 'marcel_'
   - Queries user by marcelToken
   - Sets userId in context
   - Continues to route handler
4. Route returns user's quests
```

### Web Authentication (unchanged)
```
1. User logs in via web
2. Backend sets JWT cookies (access_token, refresh_token)
3. Subsequent requests include cookies
4. Backend hybridAuthMiddleware:
   - No Marcel token found
   - Falls back to jwtMiddleware
   - Validates JWT from cookies
   - Sets userId in context
5. Route returns data
```

## Configuration Priority

CLI configuration priority (highest to lowest):
1. Environment variables (`MARCEL_TOKEN`, `MARCEL_API_ENDPOINT`)
2. Config file (`~/.marcel.yml`)
3. Default values (`http://localhost:3000`)

## Files Modified

### Backend (3 files)
- ✅ `src/lib/jwt.ts` - Added hybrid middleware
- ✅ `src/routes/quest.ts` - Updated to use hybrid middleware
- ✅ `src/routes/user.ts` - Already had token endpoints

### Frontend (1 file)
- ✅ `src/routes/(app)/settings/+page.svelte` - Added token management UI

### CLI (5 files)
- ✅ `config/config.go` - Updated config path
- ✅ `models/models.go` - Fixed field names
- ✅ `main.go` - Updated help text
- ✅ `ui/ui.go` - Updated help screen
- ✅ `README.md` - Updated documentation

## Security Considerations

1. **Token Generation**
   - Uses `crypto.randomBytes(32)` (256 bits of entropy)
   - Prefixed with `marcel_` for easy identification
   - Stored as unique constraint in database

2. **Token Storage**
   - Users should store in environment variables (not in code)
   - Config file at `~/.marcel.yml` (user's home directory)
   - Transmitted over HTTPS in production

3. **Token Validation**
   - Validated on every request via database lookup
   - No expiration (similar to API keys)
   - Can be regenerated by user at any time

4. **Scope**
   - Tokens have same permissions as user's web session
   - No granular permissions (acts as user)
   - Use for personal CLI access only

## Testing Verification

All components verified:
- ✅ CLI builds successfully
- ✅ Backend compiles with new middleware
- ✅ Config references use `~/.marcel.yml`
- ✅ `hybridAuthMiddleware` defined and used
- ✅ Frontend includes token management UI

## Usage Example

```bash
# 1. Generate token in web app Settings
# 2. Configure CLI
export MARCEL_TOKEN="marcel_abc123def456..."
export MARCEL_API_ENDPOINT="http://localhost:3000"

# 3. Build and run CLI
cd cli
make build
./build/marcel

# 4. Use CLI
# - Navigate with ↑/↓ or j/k
# - Toggle quests with Space
# - Refresh with 'r'
# - Help with '?'
# - Quit with 'q'
```

## Backward Compatibility

- ✅ Web app unchanged (still uses JWT cookies)
- ✅ Existing users not affected
- ✅ Token is optional (only needed for CLI)
- ✅ All existing API endpoints work as before

## Future Enhancements

Potential improvements (not implemented):
- Token expiration/rotation
- Multiple tokens per user (different devices)
- Token scopes/permissions
- Token usage analytics
- Revoke specific tokens
